<!-- Global Messages -->
<div *ngIf="message" [ngClass]="{ 'message': true, 'success': message.type === 'success', 'error': message.type === 'error' }">
    {{ message.text }}
  </div>
  
  <!-- Loading Overlay -->
  <div *ngIf="isLoading" class="loading-overlay">
    <div class="loading-spinner"></div>
  </div>
  
  <!-- Header -->
  <div class="header-section">
    <h2>Company List</h2>
    <button (click)="navigateToAddCompany()" class="btn btn-add-company">Add New Company</button>
  </div>
  
  <!-- Company List -->
  <ul class="company-list">
    <li *ngFor="let company of companies" class="company-item">
      <div class="company-header">
        <h3>{{ company.company_name }}</h3>
        <p>Industry: {{ company.industry }}</p>
  
        <div class="button-group">
          <button class="btn btn-view" (click)="toggleProjects(company.company_id)" [disabled]="isLoading">
            {{ showProjects && selectedCompanyId === company.company_id ? 'Hide Projects' : 'View Projects' }}
          </button>
          <button class="btn btn-add" (click)="toggleAddForm(company.company_id)" [disabled]="isLoading">
            {{ showAddForm && selectedCompanyId === company.company_id ? 'Cancel' : 'Add Project' }}
          </button>
        </div>
      </div>
  
      <!-- Projects List -->
      <div *ngIf="selectedCompanyId === company.company_id && showProjects" class="projects-section">
        <h4>Projects</h4>
        <div *ngIf="company.projects?.length === 0" class="no-projects">No projects found for this company</div>
        <ul *ngIf="company.projects?.length > 0" class="projects-list">
          <li *ngFor="let project of company.projects" class="project-item">
            <h5>{{ project.project_title }}</h5>
            <p>Category: {{ project.project_category }}</p>
            <p>Goal Amount: ${{ project.goal_amount }}</p>
            <p>Status: {{ project.project_status }}</p>
          </li>
        </ul>
      </div>
  
      <!-- Add Project Form -->
      <div *ngIf="showAddForm && selectedCompanyId === company.company_id" class="add-project-form">
        <h4>Add New Project</h4>
        <form [formGroup]="projectForm" (ngSubmit)="showPaymentDialog()">
          <div class="form-group" *ngFor="let control of [
            {name:'project_title',placeholder:'Project Title', minLen:3, msg:'Title is required and must be at least 3 characters'},
            {name:'project_category',placeholder:'Project Category', minLen:2, msg:'Category is required and must be at least 2 characters'},
            {name:'goal_amount',placeholder:'Goal Amount', type:'number', msg:'Goal amount must be greater than 0'},
            {name:'phone_number',placeholder:'Phone Number', msg:'Please enter a valid 10-digit phone number'},
            {name:'start_date',placeholder:'Start Date', type:'date', msg:'Start date must be a future date'},
            {name:'end_date',placeholder:'End Date', type:'date', msg:'End date must be a future date'}
          ]">
            <input *ngIf="!control.type || control.type === 'text' || control.type === 'number'" 
                   [attr.type]="control.type || 'text'" 
                   [formControlName]="control.name"
                   [placeholder]="control.placeholder"
                   [class.error-input]="projectForm.get(control.name)?.invalid && projectForm.get(control.name)?.touched" />
            <input *ngIf="control.type === 'date'" 
                   type="date" 
                   [formControlName]="control.name"
                   [class.error-input]="projectForm.get(control.name)?.invalid && projectForm.get(control.name)?.touched" />
            <div *ngIf="projectForm.get(control.name)?.invalid && projectForm.get(control.name)?.touched" class="error-message">
              {{ control.msg }}
            </div>
          </div>
  
          <div class="form-group">
            <textarea formControlName="project_description" placeholder="Project Description"
              [class.error-input]="projectForm.get('project_description')?.invalid && projectForm.get('project_description')?.touched"></textarea>
            <div *ngIf="projectForm.get('project_description')?.invalid && projectForm.get('project_description')?.touched" class="error-message">
              Description cannot exceed 500 characters
            </div>
          </div>
  
          <div class="form-group">
            <select formControlName="plan_id"
                    [class.error-input]="projectForm.get('plan_id')?.invalid && projectForm.get('plan_id')?.touched"
                    (change)="onPlanSelect()" required>
              <option [ngValue]="null">Select a Plan</option>
              <option *ngFor="let plan of plans" [ngValue]="plan.plan_id">
                {{ plan.plan_description }} - ${{ plan.plan_price }}
              </option>
            </select>
            <div *ngIf="projectForm.get('plan_id')?.invalid && projectForm.get('plan_id')?.touched" class="error-message">
              Please select a plan
            </div>
          </div>
  
          <div class="form-group">
            <select formControlName="project_status"
                    [class.error-input]="projectForm.get('project_status')?.invalid && projectForm.get('project_status')?.touched">
              <option *ngFor="let status of projectStatuses" [value]="status.value">{{ status.label }}</option>
            </select>
            <div *ngIf="projectForm.get('project_status')?.invalid && projectForm.get('project_status')?.touched" class="error-message">
              Please select a project status
            </div>
          </div>
  
          <div *ngIf="projectForm.errors?.['dateRange']" class="error-message">
            End date must be after start date
          </div>
  
          <!-- Payment Info -->
          <div *ngIf="selectedPlan" class="payment-info">
            <p>Plan Price: ${{ selectedPlan.plan_price }}</p>
            <p>Fees (1.5% of goal amount): ${{ fees }}</p>
            <p>Total Amount: ${{ totalAmount }}</p>
          </div>
  
          <div class="form-actions">
            <div *ngIf="!paid" class="payment-section">
              <button type="submit" [disabled]="projectForm.invalid || isSubmitting" class="submit-button">
                {{ isSubmitting ? 'Processing...' : 'Proceed to Payment' }}
              </button>
            </div>
            <div *ngIf="paid" class="payment-success">
              <p class="success-text">âœ“ Payment Successful</p>
            </div>
            <button type="button" class="create-button"
                    (click)="createProject()"
                    [disabled]="!paid || projectForm.invalid || isSubmitting">
              Create Project
            </button>
          </div>
        </form>
      </div>
  
      <!-- Payment Form -->
      <div *ngIf="showPaymentForm && selectedPlan" class="payment-form">
        <h3>Payment Details</h3>
        <form (ngSubmit)="processPayment()">
          <div class="payment-summary">
            <p>Plan Price: ${{ selectedPlan.plan_price }}</p>
            <p>Fees: ${{ fees }}</p>
            <p>Total Amount: ${{ totalAmount }}</p>
          </div>
  
          <div class="form-group">
            <label for="cardNumber">Card Number:</label>
            <input type="text" id="cardNumber" [(ngModel)]="paymentDetails.cardNumber" name="cardNumber" placeholder="1234 5678 9012 3456" required>
          </div>
  
          <div class="form-row">
            <div class="form-group">
              <label for="expiryDate">Expiry Date:</label>
              <input type="text" id="expiryDate" [(ngModel)]="paymentDetails.expiryDate" name="expiryDate" placeholder="MM/YY" required>
            </div>
            <div class="form-group">
              <label for="cvv">CVV:</label>
              <input type="text" id="cvv" [(ngModel)]="paymentDetails.cvv" name="cvv" placeholder="123" required>
            </div>
          </div>
  
          <div class="form-group">
            <label for="cardName">Name on Card:</label>
            <input type="text" id="cardName" [(ngModel)]="paymentDetails.cardName" name="cardName" placeholder="John Doe" required>
          </div>
  
          <div class="payment-actions">
            <button type="submit" class="btn btn-success">Pay Now</button>
            <button type="button" class="btn btn-secondary" (click)="cancelPayment()">Cancel</button>
          </div>
        </form>
      </div>
    </li>
  </ul>
  